# 备份功能更新总结

## 功能概述
为MShell添加了完整的数据备份与恢复功能，支持手动备份/导入和定时自动备份。

## 新增文件

### 1. BackupManager.ts (`electron/managers/BackupManager.ts`)
**核心备份管理器**，提供以下功能：
- 数据加密/解密（AES-256-CBC）
- 创建备份（包含会话、命令片段、设置）
- 恢复备份
- 自动备份调度
- 备份文件管理（列表、删除、清理旧备份）

**关键特性：**
- 使用scrypt密钥派生函数增强安全性
- 备份文件格式：`.mshell`（加密的JSON数据）
- 支持配置备份间隔（6/12/24/48小时或每周）
- 自动清理超过最大数量的旧备份

### 2. backup-handlers.ts (`electron/ipc/backup-handlers.ts`)
**IPC处理器**，注册以下API：
- `backup:getConfig` - 获取备份配置
- `backup:updateConfig` - 更新备份配置
- `backup:create` - 创建备份
- `backup:restore` - 恢复备份
- `backup:apply` - 应用备份数据
- `backup:list` - 列出所有备份
- `backup:delete` - 删除备份
- `backup:selectSavePath` - 选择保存路径
- `backup:selectOpenPath` - 选择打开路径

## 修改文件

### 1. main.ts
- 导入并初始化BackupManager
- 注册备份IPC处理器
- 在应用退出时清理备份定时器

### 2. preload.ts
- 添加backup API到electronAPI
- 暴露所有备份相关方法给渲染进程

### 3. SettingsPanel.vue
**新增"备份"标签页**，包含三个区域：

#### 自动备份设置
- 启用/禁用自动备份开关
- 备份间隔选择（6/12/24/48小时/每周）
- 保留备份数量设置（1-50个）
- 显示最后备份时间

#### 手动备份操作
- **创建备份**按钮：
  - 弹出对话框输入加密密码
  - 选择保存位置
  - 创建加密备份文件
  
- **恢复备份**按钮：
  - 选择备份文件
  - 输入解密密码
  - 预览备份内容（会话数、片段数）
  - 选择要恢复的数据类型
  - 应用恢复

#### 备份历史
- 表格显示所有本地备份
- 显示文件名、大小、日期
- 支持快速恢复和删除操作

## 数据结构

### BackupData
```typescript
{
  version: string        // 备份格式版本
  timestamp: string      // 备份时间戳
  sessions: any[]        // SSH会话数据
  snippets: any[]        // 命令片段数据
  settings: any          // 应用设置
}
```

### BackupConfig
```typescript
{
  enabled: boolean       // 是否启用自动备份
  interval: number       // 备份间隔（小时）
  maxBackups: number     // 最大保留备份数
  lastBackup?: string    // 最后备份时间
}
```

## 安全特性

1. **AES-256-CBC加密**：所有备份数据使用强加密算法
2. **密钥派生**：使用scrypt从用户密码派生加密密钥
3. **随机IV**：每次加密使用随机初始化向量
4. **密码保护**：用户必须提供密码才能创建和恢复备份

## 使用流程

### 创建备份
1. 打开设置 → 备份标签页
2. 点击"创建备份"按钮
3. 输入并确认加密密码
4. 选择保存位置
5. 等待备份完成

### 恢复备份
1. 打开设置 → 备份标签页
2. 点击"恢复备份"按钮
3. 选择备份文件
4. 输入解密密码
5. 选择要恢复的数据类型
6. 确认恢复

### 自动备份
1. 打开设置 → 备份标签页
2. 启用"自动备份"开关
3. 设置备份间隔和保留数量
4. 系统将按设置自动创建备份

## 文件位置

- **备份目录**：`%APPDATA%/MShell/backups/`
- **备份配置**：`%APPDATA%/MShell/backup-config.json`
- **备份文件格式**：`backup-{timestamp}.mshell`

## 注意事项

1. **密码管理**：备份密码非常重要，丢失后无法恢复数据
2. **自动备份密码**：自动备份使用默认密码，建议定期手动创建带自定义密码的备份
3. **备份大小**：备份文件大小取决于会话和片段数量
4. **恢复策略**：恢复操作会添加数据，不会覆盖现有数据

## 后续优化建议

1. 支持导出到云存储（OneDrive、Google Drive等）
2. 支持增量备份减少文件大小
3. 添加备份完整性校验
4. 支持备份加密算法选择
5. 添加备份压缩功能
6. 支持备份前预览当前数据

## 测试建议

1. 测试创建备份功能
2. 测试恢复备份功能
3. 测试密码错误处理
4. 测试自动备份调度
5. 测试备份文件清理
6. 测试大量数据备份性能
